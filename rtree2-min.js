(function(b){var a=function(c){var e=3;var d=6;if(!isNaN(c)){e=Math.floor(c/2);d=c}var h={x:0,y:0,w:0,h:0,id:"root",nodes:[]};var l=function(q){return Object.prototype.toString.call(q)==="[object Array]"};var k=(function(){var q={};return function(s){var r=0;if(s in q){r=q[s]++}else{q[s]=0}return s+"_"+r}})();a.Rectangle.squarified_ratio=function(r,q,v){var u=(r+q)/2;var t=r*q;var s=t/(u*u);return(t*v/s)};var g=function(w,s,x){var y=[];var u=[];var z=[];var A=1;if(!w||!a.Rectangle.overlap_rectangle(w,x)){return z}var q={x:w.x,y:w.y,w:w.w,h:w.h,target:s};u.push(x.nodes.length);y.push(x);do{var C=y.pop();var r=u.pop()-1;if("target" in q){while(r>=0){var v=C.nodes[r];if(a.Rectangle.overlap_rectangle(q,v)){if((q.target&&"leaf" in v&&v.leaf===q.target)||(!q.target&&("leaf" in v||a.Rectangle.contains_rectangle(v,q)))){if("nodes" in v){z=o(v,true,[],v);C.nodes.splice(r,1)}else{z=C.nodes.splice(r,1)}a.Rectangle.make_MBR(C.nodes,C);delete q.target;if(C.nodes.length<e){q.nodes=o(C,true,[],C)}break}else{if("nodes" in v){A+=1;u.push(r);y.push(C);C=v;r=v.nodes.length}}}r-=1}}else{if("nodes" in q){C.nodes.splice(r+1,1);if(C.nodes.length>0){a.Rectangle.make_MBR(C.nodes,C)}for(var B=0;B<q.nodes.length;B++){j(q.nodes[B],C)}q.nodes.length=0;if(y.length==0&&C.nodes.length<=1){q.nodes=o(C,true,q.nodes,C);C.nodes.length=0;y.push(C);u.push(1)}else{if(y.length>0&&C.nodes.length<e){q.nodes=o(C,true,q.nodes,C);C.nodes.length=0}else{delete q.nodes}}}else{a.Rectangle.make_MBR(C.nodes,C)}}A-=1}while(y.length>0);return(z)};var n=function(y,z){var u=-1;var x=[];var B;var C=function(E,D){return(function(F){E._attach_data(D,F)})};x.push(z);var q=z.nodes;do{if(u!=-1){x.push(q[u]);q=q[u].nodes;u=-1}for(var s=q.length-1;s>=0;s--){var w=q[s];if("leaf" in w){u=-1;break}var v=a.Rectangle.squarified_ratio(w.w,w.h,w.nodes.length+1);var t=Math.max(w.x+w.w,y.x+y.w)-Math.min(w.x,y.x);var r=Math.max(w.y+w.h,y.y+y.h)-Math.min(w.y,y.y);var A=a.Rectangle.squarified_ratio(t,r,w.nodes.length+2);if(u<0||Math.abs(A-v)<B){B=Math.abs(A-v);u=s}}}while(u!=-1);return(x)};var f=function(q){var r=m(q);while(q.length>0){i(q,r[0],r[1])}return(r)};var i=function(q,D,C){var u=a.Rectangle.squarified_ratio(D.w,D.h,D.nodes.length+1);var t=a.Rectangle.squarified_ratio(C.w,C.h,C.nodes.length+1);var s;var z;var E;for(var x=q.length-1;x>=0;x--){var r=q[x];var y={};y.x=Math.min(D.x,r.x);y.y=Math.min(D.y,r.y);y.w=Math.max(D.x+D.w,r.x+r.w)-y.x;y.h=Math.max(D.y+D.h,r.y+r.h)-y.y;var B=Math.abs(a.Rectangle.squarified_ratio(y.w,y.h,D.nodes.length+2)-u);var w={};w.x=Math.min(C.x,r.x);w.y=Math.min(C.y,r.y);w.w=Math.max(C.x+C.w,r.x+r.w)-w.x;w.h=Math.max(C.y+C.h,r.y+r.h)-w.y;var A=Math.abs(a.Rectangle.squarified_ratio(w.w,w.h,C.nodes.length+2)-t);if(!z||!s||Math.abs(A-B)<s){z=x;s=Math.abs(A-B);E=A<B?C:D}}var v=q.splice(z,1)[0];if(D.nodes.length+q.length+1<=e){D.nodes.push(v);a.Rectangle.expand_rectangle(D,v)}else{if(C.nodes.length+q.length+1<=e){C.nodes.push(v);a.Rectangle.expand_rectangle(C,v)}else{E.nodes.push(v);a.Rectangle.expand_rectangle(E,v)}}};var m=function(q){var s=q.length-1;var A=0;var r=q.length-1;var y=0;var w,v;for(var u=q.length-2;u>=0;u--){var t=q[u];if(t.x>q[A].x){A=u}else{if(t.x+t.w<q[s].x+q[s].w){s=u}}if(t.y>q[y].y){y=u}else{if(t.y+t.h<q[r].y+q[r].h){r=u}}}var z=Math.abs((q[s].x+q[s].w)-q[A].x);var x=Math.abs((q[r].y+q[r].h)-q[y].y);if(z>x){if(s>A){w=q.splice(s,1)[0];v=q.splice(A,1)[0]}else{v=q.splice(A,1)[0];w=q.splice(s,1)[0]}}else{if(r>y){w=q.splice(r,1)[0];v=q.splice(y,1)[0]}else{v=q.splice(y,1)[0];w=q.splice(r,1)[0]}}return([{x:w.x,y:w.y,w:w.w,h:w.h,nodes:[w]},{x:v.x,y:v.y,w:v.w,h:v.h,nodes:[v]}])};var p=function(r,q){r.nodes=q.nodes;r.x=q.x;r.y=q.y;r.w=q.w;r.h=q.h;return(r)};var o=function(v,s,u,w){var x=[];if(!a.Rectangle.overlap_rectangle(v,w)){return(u)}var y=function(A,z){return(function(B){A._attach_data(z,B)})};x.push(w.nodes);do{var q=x.pop();for(var r=q.length-1;r>=0;r--){var t=q[r];if(a.Rectangle.overlap_rectangle(v,t)){if("nodes" in t){x.push(t.nodes)}else{if("leaf" in t){if(!s){u.push(t.leaf)}else{u.push(t)}}}}}}while(x.length>0);return(u)};var j=function(q,w){var u;if(w.nodes.length==0){w.x=q.x;w.y=q.y;w.w=q.w;w.h=q.h;w.nodes.push(q);return}var s=n(q,w);var r=q;do{if(u&&"nodes" in u&&u.nodes.length==0){var z=u;u=s.pop();for(var y=0;y<u.nodes.length;y++){if(u.nodes[y]===z||u.nodes[y].nodes.length==0){u.nodes.splice(y,1);break}}}else{u=s.pop()}if("leaf" in r||"nodes" in r||l(r)){if(l(r)){for(var v=0;v<r.length;v++){a.Rectangle.expand_rectangle(u,r[v])}u.nodes=u.nodes.concat(r)}else{a.Rectangle.expand_rectangle(u,r);u.nodes.push(r)}if(u.nodes.length<=d){r={x:u.x,y:u.y,w:u.w,h:u.h}}else{var x=f(u.nodes);r=x;if(s.length<1){u.nodes.push(x[0]);s.push(u);r=x[1]}}}else{a.Rectangle.expand_rectangle(u,r);r={x:u.x,y:u.y,w:u.w,h:u.h}}}while(s.length>0)};this.get_tree=function(){return h};this.set_tree=function(r,q){if(!q){q=h}return(p(q,r))};this.search=function(r,s,q){if(arguments.length<1){throw"Wrong number of arguments. RT.Search requires at least a bounding rectangle."}switch(arguments.length){case 1:arguments[1]=false;case 2:arguments[2]=[];case 3:arguments[3]=h;default:arguments.length=4}return(o.apply(this,arguments))};this.toJSON=function(z,E){var B=[];var w=[];var A={};var s=3;var C=1;var r="";if(z&&!a.Rectangle.overlap_rectangle(z,h)){return""}if(!E){w.push(h.nodes.length);B.push(h.nodes);r+="var main_tree = {x:"+h.x.toFixed()+",y:"+h.y.toFixed()+",w:"+h.w.toFixed()+",h:"+h.h.toFixed()+",nodes:["}else{s+=4;w.push(E.nodes.length);B.push(E.nodes);r+="var main_tree = {x:"+E.x.toFixed()+",y:"+E.y.toFixed()+",w:"+E.w.toFixed()+",h:"+E.h.toFixed()+",nodes:["}do{var q=B.pop();var v=w.pop()-1;if(v>=0&&v<q.length-1){r+=","}while(v>=0){var y=q[v];if(!z||a.Rectangle.overlap_rectangle(z,y)){if(y.nodes){if(C>=s){var x=A.length;var u=k("saved_subtree");r+="{x:"+y.x.toFixed()+",y:"+y.y.toFixed()+",w:"+y.w.toFixed()+",h:"+y.h.toFixed()+",load:'"+u+".js'}";A[u]=this.toJSON(z,y);if(v>0){r+=","}}else{r+="{x:"+y.x.toFixed()+",y:"+y.y.toFixed()+",w:"+y.w.toFixed()+",h:"+y.h.toFixed()+",nodes:[";C+=1;w.push(v);B.push(q);q=y.nodes;v=y.nodes.length}}else{if(y.leaf){var t=y.leaf.toJSON?y.leaf.toJSON():JSON.stringify(y.leaf);r+="{x:"+y.x.toFixed()+",y:"+y.y.toFixed()+",w:"+y.w.toFixed()+",h:"+y.h.toFixed()+",leaf:"+t+"}";if(v>0){r+=","}}else{if(y.load){r+="{x:"+y.x.toFixed()+",y:"+y.y.toFixed()+",w:"+y.w.toFixed()+",h:"+y.h.toFixed()+",load:'"+y.load+"'}";if(v>0){r+=","}}}}}v-=1}if(v<0){r+="]}";C-=1}}while(B.length>0);r+=";";for(var D in A){r+="\nvar "+D+" = function(){"+A[D]+" return(main_tree);};"}return(r)};this.remove=function(r,t){if(arguments.length<1){throw"Wrong number of arguments. RT.remove requires at least a bounding rectangle."}switch(arguments.length){case 1:arguments[1]=false;case 2:arguments[2]=h;default:arguments.length=3}if(arguments[1]===false){var q=0;var s=[];do{q=s.length;s=s.concat(g.apply(this,arguments))}while(q!=s.length);return s}else{return(g.apply(this,arguments))}};this.insert=function(q,r){if(arguments.length<2){throw"Wrong number of arguments. RT.Insert requires at least a bounding rectangle and an object."}return(j({x:q.x,y:q.y,w:q.w,h:q.h,leaf:r},h))}};a.Rectangle=function(e,d,f,m){var k,c,i,j,l,g;if(e.x){k=e.x;i=e.y;if(e.w!==0&&!e.w&&e.x2){l=e.x2-e.x;g=e.y2-e.y}else{l=e.w;g=e.h}c=k+l;j=i+g}else{k=e;i=d;l=f;g=m;c=k+l;j=i+g}this.x1=this.x=function(){return k};this.y1=this.y=function(){return i};this.x2=function(){return c};this.y2=function(){return j};this.w=function(){return l};this.h=function(){return g};this.toJSON=function(){return('{"x":'+k.toString()+', "y":'+i.toString()+', "w":'+l.toString()+', "h":'+g.toString()+"}")};this.overlap=function(h){return(this.x()<h.x2()&&this.x2()>h.x()&&this.y()<h.y2()&&this.y2()>h.y())};this.expand=function(n){var h=Math.min(this.x(),n.x());var o=Math.min(this.y(),n.y());l=Math.max(this.x2(),n.x2())-h;g=Math.max(this.y2(),n.y2())-o;k=h;i=o;return(this)};this.setRect=function(p,o,q,z){var u,n,s,t,v,r;if(p.x){u=p.x;s=p.y;if(p.w!==0&&!p.w&&p.x2){v=p.x2-p.x;r=p.y2-p.y}else{v=p.w;r=p.h}n=u+v;t=s+r}else{u=p;s=o;v=q;r=z;n=u+v;t=s+r}}};a.Rectangle.overlap_rectangle=function(d,c){return(d.x<(c.x+c.w)&&(d.x+d.w)>c.x&&d.y<(c.y+c.h)&&(d.y+d.h)>c.y)};a.Rectangle.contains_rectangle=function(d,c){return((d.x+d.w)<=(c.x+c.w)&&d.x>=c.x&&(d.y+d.h)<=(c.y+c.h)&&d.y>=c.y)};a.Rectangle.expand_rectangle=function(e,d){var c=Math.min(e.x,d.x);var f=Math.min(e.y,d.y);e.w=Math.max(e.x+e.w,d.x+d.w)-c;e.h=Math.max(e.y+e.h,d.y+d.h)-f;e.x=c;e.y=f;return(e)};a.Rectangle.make_MBR=function(c,e){if(c.length<1){return({x:0,y:0,w:0,h:0})}if(!e){e={x:c[0].x,y:c[0].y,w:c[0].w,h:c[0].h}}else{e.x=c[0].x}e.y=c[0].y;e.w=c[0].w;e.h=c[0].h;for(var d=c.length-1;d>0;d--){a.Rectangle.expand_rectangle(e,c[d])}return(e)};b.RTree=a})(window);