<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" 
                    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<script src="http://code.jquery.com/jquery-latest.js"></script>
<link rel="stylesheet" href="http://github.com/jquery/qunit/raw/master/qunit/qunit.css" type="text/css" media="screen" />
<script type="text/javascript" src="http://github.com/jquery/qunit/raw/master/qunit/qunit.js"></script>
<script type="text/javascript" src="src/core.js"></script>
<script type="text/javascript" src="src/2D.js"></script>
<script type="text/javascript" src="src/extensions.js"></script>
<script type="text/javascript" src="RTree.js"></script>
<script type="text/javascript" src="components.js"></script>

<title>RTree Unit Test</title>

<script>
$(document).ready(function(){
	
	module("Box");
	
	test("update", function() {
		var box = new Box(50,50,100,100,null,1);
		box.children.length = 1;
		box.update(140,140,50,50);
		
		equals(box.x, 50, "x maintains position");
		equals(box.y, 50, "y maintains position");
		equals(box.w, 140, "w updates");
		equals(box.h, 140, "h updates");
		
		box.update(25,25,100,200);
		
		equals(box.x, 25, "x updates");
		equals(box.y, 25, "y updates");
		equals(box.w, 140, "w stays same");
		equals(box.h, 200, "h updates");
		
	});
	
	test("divide", function() {
		var box = new Box(50,50,100,100,null,1);
		box.children = [
			new Box(51,51,10,10,box,2,"blue"),
			new Box(65,51,10,10,box,2,"blue"),
			new Box(80,51,10,10,box,2,"blue"),
			new Box(95,51,10,10,box,2,"blue"),
			new Box(110,51,10,10,box,2,"blue"),
			new Box(125,51,10,10,box,2,"blue"),
		];
		box.divide();
		
		equals(box.children.length, 2, "Divided into two");
	});
	
	test("get", function() {
		var box = new Box(50,50,100,100,null,1);
		box.children = [
			new Box(51,51,10,10,box,2,"blue"),
			new Box(65,51,10,10,box,2,"blue"),
			new Box(80,51,10,10,box,2,"blue"),
			new Box(95,51,10,10,box,2,"blue"),
			new Box(110,51,10,10,box,2,"blue"),
			new Box(125,51,10,10,box,2,"blue"),
		];
		box.divide();
		
		create(60,60,5,5,true,"white");
		var q = box.get(60,60,5,5);
	});
	
	module("RTree");

	test("insertion", function() {
		tree = new RTree();
		tree.put(150,5, 50, 50, "test");
		tree.put(60,6, 20, 20, "neighbor");
		tree.put(40,46, 50, 50, "neighbor 2");
		tree.put(180,6, 200, 50, "neighbor 3");
		tree.put(10,16, 50, 50, "neighbor 4");
		tree.put(1006,106, 100, 100, "neighbor 5");
		tree.put(406,106, 50, 50, "neighbor 6");
		
		create(0,0,10,10,true,"white");
		var q = tree.find(0,0,10,10);
		equals(q.length, 0, "Found none");
		
		create(100,0,800,900,true,"white");
		var q = tree.find(100,0,800,900);
		equals(q.length, 3, "Found 3");
		console.log(q);
		//tree.destroy();
	});
	
	test("Large Dataset", function() {
		tree = new RTree();
		var search = {x:150, y:150, w:500, h:500};
		create(150,150,500,500, true, "blue");
		for(var i = 0; i < 10000; i++) {
			var e = Crafty.e("2D");
			var x = randrange(0, Crafty.window.width);
			var y = randrange(0, Crafty.window.height);
			
			e.attr({x: x, y: y, w: 50, h: 50});
			tree.put(e);
		}
		
		var e = Crafty.e("2D");
		e.attr({x: 200, y: 200});
		tree.put(e);
		
		//check tree
		var start = (new Date).getTime();
		var q = tree.find(search);
		var end = (new Date).getTime() - start;
		$("#player").text(end);
		
		var qids = [];
		for(i = 0; i < q.length; i++) {
			qids.push(q[i][0]);
		}
		
		
		var start2 = (new Date).getTime();
		var total2 = 0;
		Crafty("2D").each(function() {
			if(this.intersect(search)) {
				total2++;
				if($.inArray(this[0],qids) === -1) {
					console.log(this[0], this.x, this.y, this.w, this.h);
				}
			}
		});
		var end2 = (new Date).getTime() - start2;
		
		
		
		ok(end < end2, "Tree Faster");
		equals(q.length, total2, "Tree == Brute");
		console.log(total2, q.length, "|", end, end2);
		
	});
	//*/
	function randrange(from,to) {
		return Math.round(Math.random() * (to - from) + from);
	}
	
	
});

function create(x,y,w,h,intern,color) {
	var node = document.createElement("div");
	node.setAttribute("class","bound");
	if(intern) node.setAttribute("class", "bound intern");
	document.body.appendChild(node);
	$(node).css({left: x, top: y, width: w, height: h});
	if(color) $(node).css("border-color",color);
}
if(!('console' in window)) window.console = {log: function(){}};
</script>
<style>
.bound { border:1px solid black;  position:absolute }
.intern { border-color:red; }
</style>
</head>
<body>
<div id="player"></div>
<h1 id="qunit-header">RTree Test Suite</h1>
<h2 id="qunit-banner"></h2>
<h2 id="qunit-userAgent"></h2>
<ol id="qunit-tests"></ol>
<div id="qunit-fixture">test markup, will be hidden</div>
<div id="qunit-filter-pass"></div>
</body>
</html>