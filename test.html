<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" 
                    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<script src="http://code.jquery.com/jquery-latest.js"></script>
<link rel="stylesheet" href="http://github.com/jquery/qunit/raw/master/qunit/qunit.css" type="text/css" media="screen" />
<script type="text/javascript" src="http://github.com/jquery/qunit/raw/master/qunit/qunit.js"></script>
<script type="text/javascript" src="crafty.js"></script>
<script type="text/javascript" src="components.js"></script>
<script type="text/javascript" src="QuadTree.js"></script>
<title>Crafty Unit Test</title>

<script>
$(document).ready(function(){

	module("Selector");

	test("Selector entity", function() {
		var obj = Crafty(1);
		
		ok(obj, "Crafty instance not null");
		equals(obj.length, 0, "Length of selector");
	});
	
	test("Selector component", function() {
		var e = Crafty.e("testcomp"); //create entity with a component
		var found = Crafty("testcomp");
		equals(e, found[0], "Entity is found");
		
		var ee = Crafty.e("testcomp, something, position");
		equals(Crafty("testcomp").length, 2, "Found two entities");
		equals(Crafty("something").length, 1, "Found one 'something' entity");
		
		
	});
	
	test("Advanced Selectors", function() {
		Crafty.e("morethan, two, component");
		Crafty.e("more, than, two, components");
		equals(Crafty("testcomp something").length, 1, "AND selecting multiple");
		equals(Crafty("testcomp, something").length, 2, "OR selecting multiple");
		
		equals(Crafty("morethan, two, something").length, 3, "OR selecting three");
		equals(Crafty("morethan two something").length, 0, "AND selecting none");
		equals(Crafty("morethan two component").length, 1, "AND selecting one");
	});

	module("Components");
	
	test("Inheriting Objects", function() {
		
		var c = Crafty.c("position", {
			w: 0,
			h: 0,
			
			area: function() {
				return this.w * this.h;
			}
		});
		
		var e = Crafty.e("position");
		
		equals(Crafty(e).area(),0, "Area should be default");
		
		Crafty(e).attr("w", 5).attr("h", 8);
		
		equals(Crafty(e).area(),40, "Area updated by updating the properties");
		
		Crafty(e).attr({w: 10, h: 20});
		
		equals(Crafty(e).area(),200, "Area updated by updating the properties");
	});
	
	module("Functions");
	
	test("Prototyped", function() {
		var c = Crafty.e("mycomp");
		//has
		equals(Crafty(c).has("mycomp"), true, "has()");
		equals(Crafty(c).has("mycomp2"), false, "not has()");
		
		//toArray
		equals(Crafty(c).toArray().toString(), (c).toString(), "toArray");
		
		//each
		Crafty.e("mycomp");
		var total = 0;
		Crafty("mycomp").each(function(i) {
			total++;
		});
		
		equals(total, 2, "each()");
		
		//addComponent
		Crafty(c).addComponent("newcomp");
		equals(Crafty(c).has("newcomp"), true, "addComponent standard");
		
		Crafty(c).addComponent("testcomp, another");
		equals(Crafty(c).has("testcomp") && Crafty(c).has("another"), true, "addComponent list");
		
		Crafty(c).addComponent("arg", "arg2");
		equals(Crafty(c).has("arg") && Crafty(c).has("arg2"), true, "addComponent args");
	});
	
	module("Quad Tree");
	/*
	test("Putting Arbitrary", function() {
		var tree = new Crafty.QTree();
		tree.put(5,5, "test");
		tree.put(6,6, "neighbor");
		
		var q = tree.get(4,4,10,10);
		equals(q.length, 2, "Found 2");
		
		equals(q[0].obj + q[1].obj, "testneighbor", "Found all and non-object wrapped");
		
		//must destroy
		tree.destroy();
	});
	
	test("Test Divide", function() {
		var tree = new Crafty.QTree();
		tree.put(5,5, "test");
		tree.put(6,6, "neighbor");
		tree.put(4,6, "neighbor 2");
		tree.put(8,6, "neighbor 3");
		tree.put(1,6, "neighbor 4");
		tree.put(6,6, "neighbor 5");
		
		var q = tree.get(0,0,10,10);
		
		equals(q.length, 6, "Found 6");
		tree.destroy();
	});
	
	test("Find in small region", function() {
		var tree = new Crafty.QTree();
		tree.put(5,5, "test");
		tree.put(6,6, "neighbor");
		tree.put(4,6, "neighbor 2");
		tree.put(8,6, "neighbor 3");
		tree.put(1,6, "neighbor 4");
		tree.put(106,106, "neighbor 5");
		tree.put(406,106, "neighbor 5");
		
		var q = tree.get(0,0,10,10);
		equals(q.length, 5, "Found 5");
		
		var q = tree.get(100,0,800,900);
		equals(q.length, 2, "Found 2");
		
		tree.destroy();
	});
	*/
	
	test("Large Dataset", function() {
		//tree = new Crafty.QTree();
		var search = {x:150, y:150, w:500, h:500};
		//create(150,150,500,500);
		for(var i = 0; i < 10000; i++) {
			var e = Crafty.e("2D");
			var x = randrange(0, Crafty.window.width);
			var y = randrange(0, Crafty.window.height);
			
			Crafty(e).attr({x: x, y: y, w: 50, h: 50});
			//tree.put(Crafty(e));
		}
		var e = Crafty.e("2D");
		Crafty(e).attr({x: 200, y: 200});
		//tree.put(Crafty(e));
		
		var start2 = (new Date).getTime();
		var total = 0;
		var q = Crafty("2D");
		for(i = 0; i < q.length; i++) {
			if(Crafty(q[i]).intersect(search)) {
				total++;
			}
		};
		var end2 = (new Date).getTime() - start2;
		
		$("#player").text(end2);
	});
	
	function randrange(from,to) {
		return Math.round(Math.random() * (to - from) + from);
	}
	
	
});

function create(x,y,w,h) {
	var node = document.createElement("div");
	node.setAttribute("class","bound");
	document.body.appendChild(node);
	$(node).css({left: x, top: y, width: w, height: h});
}
</script>
<style>
.bound { border:1px solid black;  position:absolute }
</style>
</head>
<body>
<div id="player"></div>
<h1 id="qunit-header">Crafty Test Suite</h1>
<h2 id="qunit-banner"></h2>
<h2 id="qunit-userAgent"></h2>
<ol id="qunit-tests"></ol>
<div id="qunit-fixture">test markup, will be hidden</div>
<div id="qunit-filter-pass"></div>
</body>
</html>